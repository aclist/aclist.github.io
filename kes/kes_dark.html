<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="author" content="Add-on manager for kbin enhancement scripts | Last updated: 2023-07-26">
<title>kbin Enhancement Suite (KES)</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url(//fonts.googleapis.com/css?family=Noto+Sans);
@import url(https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css); /* Default asciidoc style framework - important */

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */
:root{
--maincolor:#222222;
--primarycolor:#aaa;
--secondarycolor:#aaa;
--tertiarycolor:#aaa;
--sidebarbackground:#222222;
--linkcolor:#ecc89e;
--linkcoloralternate:#cbcbcb;
--white:#777777;
--codebg:#111;
--codefg:#ffffff;
--linkhover:#eb862f;
}

/* Text styles */

body{font-family: "Noto Sans",sans-serif;background-color: var(--maincolor);color:var(--white);}

h1{color:var(--primarycolor) !important;font-family:"Noto Sans",sans-serif;}
h2,h3,h4,h5,h6{color:var(--secondarycolor) !important;font-family:"Noto Sans",sans-serif;}
.title{color:var(--primarycolor) !important;font-family:"Noto Sans",sans-serif;font-style: normal; font-weight: normal;}
p{font-family: "Noto Sans",sans-serif ! important}
#toc.toc2 a:link{color:var(--linkcolor);}
#toc.toc2 {border-right: 1px solid #8e8e96}
blockquote{color:var(--tertiarycolor) !important}
.quoteblock{color:var(--white)}
code{color:var(--codefg);background-color: var(--codebg) !important}
td.tableblock{border:0 solid #a9a9a9}


/* Table styles */
th{background-color: var(--maincolor);color:var(--primarycolor) !important;}
td{background-color: var(--maincolor);color: var(--primarycolor) !important}


#toc.toc2{background-color:var(--sidebarbackground);}
#toctitle{color:var(--white);}

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
  table {
    width: 55vw!important;
    font-size: 3vw;
  }
}

.exampleblock > .content {
  background-color: var(--maincolor);
}

a {
  color: var(--linkcolor);
}

a:hover,#toc.toc2 a:hover{
	color: var(--linkhover);
}
.admonitionblock td.icon .icon-tip::before {
  text-shadow: none;
  color: var(--white);
}
.admonitionblock td.icon .icon-note::before {
  color: var(--tertiarycolor);
}
.admonitionblock td.icon .icon-important::before {
  color: var(--linkcolor);
}
/*.admonitionblock td.icon .icon-caution::before {
  color: var(--linkcoloralternate);
}*/
.admonitionblock td.icon .icon-warning::before {
  color: var(--primarycolor);
}

#preamble > .sectionbody > .paragraph:first-of-type p {
  color: var(--white);
}

.quoteblock blockquote::before {
  color: var(--primarycolor);
}
.quoteblock .attribution cite, .verseblock .attribution cite {
  color: var(--white);
}
.verseblock pre {
  color: var(--white);
}
.quoteblock blockquote, .quoteblock blockquote p {
  color: var(--white);
}

.sidebarblock {
  background: var(--sidebarbackground);
}
.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint {
  background: var(--codebg);
  color: var(--white);
}

.literalblock pre, .listingblock>.content>pre:not(.highlight), .listingblock>.content>pre[class=highlight], .listingblock>.content>pre[class^="highlight "] {
  background: var(--codebg);
}

#header .details {
  color: var(--white);
}
#header .details span.email a {
  color: var(--linkcoloralternate);
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>kbin Enhancement Suite (KES)</h1>
<div class="details">
<span id="author" class="author">Add-on manager for kbin enhancement scripts | Last updated: 2023-07-26</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_description">Description</a></li>
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_installation">Installation</a></li>
<li><a href="#_usage">Usage</a>
<ul class="sectlevel2">
<li><a href="#_main_menu">Main menu</a></li>
<li><a href="#_header_and_footer_buttons">Header and footer buttons</a></li>
<li><a href="#_settings">Settings</a></li>
<li><a href="#_troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_developers">Developers</a>
<ul class="sectlevel2">
<li><a href="#_basic_workflow">Basic workflow</a></li>
<li><a href="#_json_manifest">JSON manifest</a></li>
<li><a href="#_adding_custom_input_fields">Adding custom input fields</a></li>
<li><a href="#_script_calling_logic">Script calling logic</a></li>
<li><a href="#_retrieving_custom_settings">Retrieving custom settings</a></li>
<li><a href="#_handling_infinite_scrolling">Handling infinite scrolling</a></li>
<li><a href="#_compatibility_api">Compatibility API</a></li>
<li><a href="#_submitting_a_pr">Submitting a PR</a></li>
<li><a href="#_precautions_and_best_practices">Precautions and best practices</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Click <a href="https://aclist.github.io/kes/kes.html">here</a> for light mode</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>kbin Enhancement Suite (KES) bundles together many userscripts that add various features to kbin and adds an integrated interface for configuring them.</p>
</div>
<div class="paragraph">
<p>As such, KES is three things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A curated and audited collection of modifications (userscripts)</p>
</li>
<li>
<p>A menu for managing this collection of modifications</p>
</li>
<li>
<p>A framework for authors to add new modifications</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For users, it provides a "single pane of glass" from which to manage various usability/customization options.</p>
</div>
<div class="paragraph">
<p>For script authors, it provides a simple, human-readable format to integrate new options with minimal overhead and describes a
standardized framework for sharing settings between scripts.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Modifications are variously referred to as "features," "add-ons," and "mods" within this document.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>KES is itself a userscript that bundles other scripts. It requires any of the below
browser extensions in the *monkey family to run:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.tampermonkey.net/">TamperMonkey</a></p>
</li>
<li>
<p><a href="https://addons.mozilla.org/en-US/firefox/addon/greasemonkey/">GreaseMonkey</a> (Firefox only)</p>
</li>
<li>
<p><a href="https://violentmonkey.github.io/">ViolentMonkey</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Versions for Firefox- and Chromium-based browsers can be found on your respective add-on/extensions page.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Navigate to <a href="https://github.com/aclist/kbin-kes/raw/main/kes.user.js">the install script</a> and
follow your browser extension&#8217;s onscreen prompts to install it. Subsequent updates should be handled
seamlessly, and KES will notify you if there is a new version available.</p>
</div>
<div class="paragraph">
<p>New add-ons are deployed directly within the menu, and the suite of features should grow over time.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage">Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_main_menu">Main menu</h3>
<div class="paragraph">
<p>To open the KES settings menu, press <code>Ctrl-Shift-?</code> or click the wrench icon in the top right corner of the page. On mobile devices narrower than
512px, the icon can be found inside of the hamburger menu on the top left of the screen, next to the kbin logo.</p>
</div>
<div class="paragraph">
<p>Pressing <code>Ctrl-Shift-?</code> again, <code>Escape</code>, or clicking on the close button or anywhere outside of the menu will close it.</p>
</div>
<div class="paragraph">
<p>The menu is divided into pages; each page contains a list of modifications.
You can switch between pages by clicking on the page name in the list on the left side of the menu (or the top if on mobile).</p>
</div>
<div class="paragraph">
<p>Clicking the name of a modification will open an information panel with a description of the modification and a toggle to enable/disable it.
If the modification has any additional settings, they can be configured here.</p>
</div>
<div class="paragraph">
<p>On devices where the menu doesn&#8217;t take up the whole screen, it can be docked to the bottom of the screen by clicking the arrow
icon in the top right corner of the menu. Clicking the arrow again will undock the menu. Docking could also be used to hide the interface
out of the way in order to see changes that would otherwise be occluded by the main menu.</p>
</div>
</div>
<div class="sect2">
<h3 id="_header_and_footer_buttons">Header and footer buttons</h3>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-flask"></i></span> <strong>Changelog</strong>: a link to the KES changelog, listing all user-facing changes to date.</p>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-eye-slash"></i></span> <strong>Transparent Mode</strong>: hides the KES menu so that you can "see through" to the rest of the page and inspect how changes were applied.
This mode draws a thin border around the screen edge to indicate you are in a special mode. Click anywhere on the screen to revert to
the KES menu.</p>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-arrow-down"></i></span> <strong>Docked Mode</strong>: docks the KES menu to the bottom of the screen in a smaller size.</p>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-times"></i></span> <strong>Close</strong>: closes the KES menu.</p>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-clipboard"></i></span> <strong>Copy system info</strong>: click to copy system information to the clipboard for use when submitting a bug report. The information copied is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operating system</p>
</li>
<li>
<p>User agent (identifies the type of browser)</p>
</li>
<li>
<p>KES version number</p>
</li>
<li>
<p>Script handler (GreaseMonkey, TamperMonkey, etc.)</p>
</li>
<li>
<p>Incognito: whether private browsing is on (used to troubleshoot issues)</p>
</li>
<li>
<p>Settings: the currently saved KES settings, such as which options are on, and what settings they have</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Reset button: prompts the user to confirm whether they would like to reset all internal KES settings to the default. This reverts the state of toggles to
OFF and flushes any custom settings.</p>
</div>
</div>
<div class="sect2">
<h3 id="_settings">Settings</h3>
<div class="paragraph">
<p>The toggle state of a modification and its settings will be saved and persist across browser sessions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting">Troubleshooting</h3>
<div class="paragraph">
<p>To submit a bug report/feature request or visit the KES home page, follow the links shown within the KES menu itself, or navigate
<a href="https://github.com/aclist/kbin-kes/issues/new/choose">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_developers">Developers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_basic_workflow">Basic workflow</h3>
<div class="paragraph">
<p>If you wish to submit your scripts for integration into KES, a standardized framework is available that
makes adaptation and PR submission easy:</p>
</div>
<div class="paragraph">
<p>The metadata related to a script is defined a priori in the file <code>manifest.json</code>. KES automatically populates
its pages and assigns your add-on to the category requested, filling its contents with the fields and values you set.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set up an entrypoint function in the script which enables/disables it (See <a href="#_script_calling_logic">Script calling logic</a>)</p>
</li>
<li>
<p>Receive a boolean toggle argument from KES passed to the above function indicating
whether the user has toggled the script on or off</p>
</li>
<li>
<p>If the script defines custom input fields, use the <code>getModSettings()</code> function exposed by KES
with your script&#8217;s namespace as the argument (See <a href="#_retrieving_custom_settings">Retrieving custom settings</a>). If you wish to call internal GreaseMonkey API
functions, see <a href="#_compatibility_api">Compatibility API</a> for details on cross-compatibility and some utility functions that facilitate this.</p>
</li>
<li>
<p>Parse the resulting settings object for your desired keys and use these settings in the business
logic of your script</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Detailed explanations follow.</p>
</div>
</div>
<div class="sect2">
<h3 id="_json_manifest">JSON manifest</h3>
<div class="paragraph">
<p><code>manifest.json</code> consists of an array of objects that each represent an add-on, that is, an atomic
feature provided by a function in a third-party userscript.
Add-ons must be given a globally unique entrypoint function name and, if using custom input fields,
a globally unique namespace.</p>
</div>
<div class="paragraph">
<p>If the add-on requires custom input fields like select, radio, or
other <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input">input types</a>, they can be added under
the <code>fields</code> array, one custom field per object.</p>
</div>
<div class="paragraph">
<p>The namespace is used to store settings under a localStorage object, which is used to share
settings between KES and third-party add-ons, or between third-party add-ons.</p>
</div>
<div class="listingblock">
<div class="title">localStorage</div>
<div class="content">
<pre>Storage {
    "kes-settings": <i class="conum" data-value="1"></i><b>(1)</b>
        '{
            "addMail":true,
            "initMags":true,
            "magInstanceEntry":true,
            "hideDownvotes":true,
            "hideUpvotes":true,
            "updateTime":true,
            "changeLogo":false,
            "dock":"up",
            "checksInit":true
        }',
    codehighlights: '{"style":"gruvbox"}', <i class="conum" data-value="2"></i><b>(2)</b>
    languagefilter: '{"filter":"English"}',
    mail: '{"type":"Text","text":"PM","state":"on"}',
    timestamp: '{"offset":"Local time","state":"on"}',
    length: 6
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the above example, KES has saved the state of eight add-ons, seven of which are enabled by the user.
In addition, it has stored the position of the KES window to <code>up</code>. (This is not controlled by third party add-ons.)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Finally, the four add-ons <code>codehighlights</code>, <code>languagefilter</code>, <code>mail</code>, and <code>timestamp</code> have respectively saved
their own settings in custom namespaces. (The other three add-ons did not request any custom settings fields.)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>KES handles toggling of add-ons and passes their boolean state to the recipient script on pageload events and mutations to the thread/post content area.</p>
</div>
<div class="paragraph">
<p>The recipient script therefore does not need to poll this state or watch for page changes, as it is called as an internal function of KES when needed.</p>
</div>
<div class="paragraph">
<p>The only responsibilities of the recipient script are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Handle setup and teardown of the desired logic (show/hide elements, apply/unapply styling)</p>
</li>
<li>
<p>Parse its own namespace under localStorage and retrieve custom settings. To facilitate this, KES provides the <code>getModSettings()</code> function. See <a href="#_retrieving_custom_settings">Retrieving custom settings</a>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">manifest.json</div>
<div class="content">
<pre>  {
    "name": "Add mail",
    "author": "shazbot",
    "version": "0.1.0",
    "label": "Add mail icon",
    "desc": "Add mail link to usernames if on kbin.social",
    "login": false,
    "recurs": true, <i class="conum" data-value="1"></i><b>(1)</b>
    "link": "mypage.dotcom",
    "link_label" "My link"
    "entrypoint": "addMail",
    "namespace": "mail", <i class="conum" data-value="2"></i><b>(2)</b>
    "fields": [ <i class="conum" data-value="3"></i><b>(3)</b>
      {
        "type": "radio",
        "initial": "Text",
        "key": "type",
        "label": "Label type",
	"values": [
		"Text",
		"Icon"
	]
      },
      { <i class="conum" data-value="4"></i><b>(4)</b>
        "type": "text",
        "initial": "PM",
        "key": "text",
        "label": "Link label"
      }
    ],
    "page": "general" <i class="conum" data-value="5"></i><b>(5)</b>
  }</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If the user has enabled lazy loading (infinite scroll) and the add-on is expected to modify these new threads and/or comments, setting this value to true will ensure that the script is applied again.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A globally unique namespace under which the script&#8217;s custom field settings are stored.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>See <a href="#_adding_custom_input_fields">Adding custom input fields</a>. In the above example, the descriptive text 'Label type' will be printed on one line, followed by a line break, then two radio buttons respectively labeled 'Text' and 'Icon', in that order,
separated by line breaks, with the 'Text' radio button initially selected. The initial value of 'Text' will be saved under the <code>mail.type</code> key (i.e., prefer a text label instead of an icon) and updated if the user changes the radio button.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is followed by a descriptive label reading 'Link label', a line break,
and then a textarea initially set to the string 'PM', with this value stored under the <code>mail.text</code> key. In this example, the link label might be used by the recipient script if <code>mail.type</code> was set to <code>Text</code>. KES is agnostic to how these settings are parsed and merely populates the fields.
As far as KES is concerned, functionality of one field does not depend on another; it is up to the author to add additional fields if necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The contents of the metadata and custom fields will be added to the 'General' page of the sidebar under the feature label 'Add mail icon'. Available pages can be seen within the file <code>ui.json</code>.</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 1. basic metadata</caption>
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Optional?</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An internal, "official" name of the add-on, possibly more verbose than the user-facing string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">author</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">single author: string; multiple authors: array of strings</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The author of the add-on. This is user-facing and links back to the named profile on kbin. If you are on an instance other than kbin.social, include the full <code>@&lt;user&gt;@&lt;instance&gt;</code> designation here</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An internal version number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A short, descriptive name of the feature, used when printing it in the list of options. This
functions as the "name" of the feature seen by users</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">desc</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user-facing description of what the feature does</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">login</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether the option requires being logged into the site to function/display correctly. <code>true</code> and <code>false</code> will respectively be styled to the user-facing strings "yes" and "no"</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recurs</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If the feature should recur and apply to new elements in the tree in the event of DOM changes
to the content area, such as new posts or threads when lazy load (infinite scrolling) is enabled</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">entrypoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A globally unique entrypoint function in the recipient script used to toggle the feature
on or off.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A globally unique namespace used if the add-on exposes custom input fields (see below).
This namespace is used when parsing localStorage</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">link</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A link to external content, such as a web site or help file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">link_label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user-facing label for the link above</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An array of objects containing custom input fields</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_adding_custom_input_fields">Adding custom input fields</h3>
<div class="paragraph">
<p>Custom input fields are themselves optional, but if the <code>fields</code> array above has been declared, it must be filled with the requisite keys below.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 2. The fields array</caption>
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Optional?</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The input field type. Available types are <code>select</code>, <code>radio</code>, <code>checkbox</code>, <code>reset</code>, and miscellaneous single-value types defined <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input">here</a>. If using <code>reset</code>, limit to one per script.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">initial</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string (if checkbox, bool)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The initial value the field is set to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A unique key for this setting, stored under the object namespace defined in Table 1. This key is parsed by the recipient script in the format <code>namespace.key</code> in order to extract user-defined settings</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A descriptive label of what the setting does, printed above the input field. If stacking multiple options above each other, such as checkboxes, omitting the label field and adding a single one in the first object is supported.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">values</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>required if <code>type</code> is <code>select</code> or <code>radio</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array of strings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the type is <code>select</code> or <code>radio</code>, an array of user-facing labels, which also function as values, used to populate each option</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkbox_label</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>required if <code>type</code> is <code>checkbox</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user-facing label printed to the right of a checkbox</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">min</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>required if <code>type</code> is <code>range</code> or <code>number</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The minimum value in the range</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>required if <code>type</code> is <code>range</code> or <code>number</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum value in the range</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">step</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>optional if <code>type</code> is <code>number</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The interval by which to increment/decrement the range</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">show_value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required if <code>type</code> is <code>range</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to print the current numerical value of the range slider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch_reset</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>required if <code>type</code> is <code>reset</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array of strings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The verbatim names of input field keys that should respond to reset button events. When a reset
button is pressed, those named fields will reset to their <code>initial</code> values</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_script_calling_logic">Script calling logic</h3>
<div class="paragraph">
<p>A number of pre-existing examples can be found under the <code>/mods</code> directory of the repository.</p>
</div>
<div class="paragraph">
<p>KES calls the recipient script via the entrypoint function defined in <code>manifest.json</code> with a boolen argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function toggleOn(){
   let el = document.querySelector('.myelement')
   if (!el) {
       document.body.appendChild(el);
   }
}
function toggleOff(){
   $('.myelement').hide();
}
function myEntryPoint(toggle) {
    if (toggle)
        toggleOn();
    } else {
        toggleOff();
}</pre>
</div>
</div>
<div class="paragraph">
<p>Bear in mind that if you have defined custom input fields, such as choosing between different label/icon types or supporting custom strings, or
when an infinite scroll event occurs (<a href="#_handling_infinite_scrolling">Handling infinite scrolling</a>), KES may attempt to call the entrypoint function again and apply the new settings.</p>
</div>
<div class="paragraph">
<p>Therefore, if the element being modified already exists, you should add logic to either override its current value or return gracefully, as seen in the boilerplate examples above and below.
Otherwise, the same element may be created multiple times.</p>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_custom_settings">Retrieving custom settings</h3>
<div class="paragraph">
<p>Parsing your script&#8217;s settings is as simple as calling <code>getModSettings()</code> with the desired namespace and applying those accordingly.</p>
</div>
<div class="paragraph">
<p>You can also leverage this function to retrieve the settings of other scripts for more synergistic functionality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>let myNs = "mymod";
let settings = getModSettings(myNs);
let color = settings["color"];
let mydiv = document.querySelector("mydiv");
mydiv.style.cssText = "background-color:" + color;</pre>
</div>
</div>
<div class="paragraph">
<p>Taking the example function from an earlier section, we can combine it with the above to ensure
that if the element does not exist, it is created, and if it does exist, it is updated with the
latest setting the user applied. With this basic flow, a user can change colors/labels/other parameters
within the KES menu and see them updated immediately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function toggleOn(){
   let el = document.querySelector('.myelement')
   if (!el) {
       document.body.appendChild(el);
   }
   el.style.cssText = "bacground-color:" + color;
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_handling_infinite_scrolling">Handling infinite scrolling</h3>
<div class="paragraph">
<p>The <code>recurs</code> boolean (see <a href="#_json_manifest">JSON manifest</a>) is used to specify whether the script&#8217;s entrypoint function should be called again when
the thread (<code>'[data-controller="subject-list"]'</code>) or post content area (<code>'#comments'</code>) have DOM changes. This allows your mod to be applied again in the event of post replies, new threads being loaded in,
et cetera.</p>
</div>
<div class="paragraph">
<p>Simply set this value in the manifest and the script will be called automatically and applied to the new content.</p>
</div>
<div class="paragraph">
<p>There is no need to include additional onload event listeners or mutation observers to the script itself or watch for page events, as they are handled
at the top level by KES.</p>
</div>
</div>
<div class="sect2">
<h3 id="_compatibility_api">Compatibility API</h3>
<div class="paragraph">
<p>For compatibility between *monkey extensions, KES provides a shim function called <code>safeGM()</code> into which GM API commands can be passed.
safeGM accepts the name of a GM API function and its respective arguments. Under the hood, safeGM merely passes the function call to the respective
GM API prefix depending on whether the extension uses the underscore namespace or the GM 4.0 Promise API.</p>
</div>
<div class="paragraph">
<p>In addition, safeGM natively reimplements some function calls that were dropped in GM 4.0 but are available in other extensions (as of this
writing, <code>GM_addStyle</code>).</p>
</div>
<div class="listingblock">
<div class="title">addStyle()</div>
<div class="content">
<pre>function addCustomCSS (css) {
    const style = document.createElement('style');
    style.innerHTML = css;
    document.head.appendChild(style);
}</pre>
</div>
</div>
<div class="paragraph">
<p>These changes happen invisibly when calling safeGM, so it is enough to pass one of the function names below with the arguments you would typically pass
to such a function:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>setValue</p>
</li>
<li>
<p>getValue</p>
</li>
<li>
<p>addStyle</p>
</li>
<li>
<p>xmlhttpRequest</p>
</li>
<li>
<p>setClipboard</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are the functions currently supported, but more may be added if necessary. Given that KES handles the setting and fetching of configs, we have not
seen many scripts need to leverage extra functionality through GreaseMonkey itself.</p>
</div>
<div class="paragraph">
<p>Additional, <code>GM_info</code> can be invoked using <code>safeGM("info")</code> and the properties of the resulting object parsed out, e.g., <code>safeGM("info").script.version</code>.</p>
</div>
<div class="paragraph">
<p>Note that if using <code>setValue</code>, <code>getValue</code>, and <code>xmlHttpRequest</code>, you will need to call safeGM asynchronously and await the results to support GM 4.0. This
should generally not be necessary, as KES handles storage of settings.</p>
</div>
<div class="paragraph">
<p>Also note that getResourceText is not available in GM 4.0, so in the unlikely event that you need to use this function in a script, rather than defining
<code>@resource</code> fields, you should fall back on <code>xmlhttpRequest</code>, or in this case, <code>genericXMLRequest</code> (outlined below), and parse the results on callback.</p>
</div>
<div class="paragraph">
<p>Lastly, KES provides a utility function called <code>genericXMLRequest()</code> that wraps <code>xmlhttpRequest</code> to perform a GET request and obviates setting
up an object: simply pass the remote URL and callback function as arguments and process the response in your callback function.</p>
</div>
<div class="listingblock">
<div class="title">genericXMLRequest()</div>
<div class="content">
<pre>function genericXMLRequest (url, callback) {
    safeGM("xmlhttpRequest", {
        method: 'GET',
        url: url,
        onload: callback,
        headers: {
            "User-Agent": "Mozilla/5.0",
            "Accept": "text/xml"
        },

    });
};</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_submitting_a_pr">Submitting a PR</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone the repo and prepare a patch against the <code>testing</code> branch.</p>
</li>
<li>
<p>If you are submitting a userscript, limit PRs to one per atomic script. If a collection of functions in the script are semantically related to each other, you may
choose to group them into one script, but they must be given unique objects, entrypoints, and namespaces within <code>manifest.json</code> (one feature per add-on). Generally speaking, different features should be limited to atomic scripts.</p>
</li>
<li>
<p>Scripts should not wantonly change the appearance and style of the page in the way a CSS theme would.
Limit features to small functionality changes that leverage the advantages of JS over CSS.
KES works best in the aggregate, when its add-ons synergize with each other.</p>
</li>
<li>
<p>For testing purposes, you can define remote resources in the <code>@require</code> fields of your local copy of the <code>kes.user.js</code> headers when debugging, but the PR itself must not include any
modifications to this file or to the <code>VERSION</code> file. Only submit a modified <code>manifest.json</code> and add your script to the <code>/mods</code> directory.</p>
</li>
<li>
<p>Ensure that the <code>entrypoint</code> and <code>namespace</code> (if applicable) defined in <code>manifest.json</code> are globally unique.</p>
</li>
<li>
<p>If your script has external dependencies (<code>@require</code>) that are not included in KES, please request these to be added when making the PR so that they
can be added at the top level. Note that jQuery is provided by default and can be used to reduce the verbosity of your script.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are submitting a PR changing an internal feature of KES itself, feel free to include changes to other files than the above.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_precautions_and_best_practices">Precautions and best practices</h3>
<div class="ulist">
<ul>
<li>
<p>Prefer private functions and local variables to reduce the possibility of collisions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bear in mind that KES ingests all of the script functions together into its scope, so unique identifiers are important.
While scripts are integration tested before deployment, you can make the testing process easier by using unique names and limiting the available
scope.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No need to handle extra event listeners</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unless you are creating a special button or widget triggering on, e.g., clicks, there is no need to actively watch the page for changes (like <code>onload</code>), as KES
handles this for you and will apply your changes accordingly in the event of infinite scrolling, reload events, etc.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Aim for minimal, concise features that do one simple thing well</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most scripts can be ported over as-is with little or no changes, but remember that KES is designed to take the complexity of setup out of the
equation, allowing many small mods to be incorporated and synergize with each other. It is enough to create an entrypoint function that triggers some
changes, request the desired UI via the JSON manifest, and the rest should work out of the box. Therefore, think of scripts as atomic features rather than
complex workflows; scripts that make highly opinionated changes or themselves create complex menus may be difficult to adapt.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If changing colors on a page, it is best to respect kbin&#8217;s internal themes by using the variables provided. These can be explored under the <code>var(--kbin-*)</code> prefix.
A number of variables for success, alerts, backgrounds, text, hover, etc. are provided. These map to different colors within the theme a user has selected. If you hardcode
an element to a specific color, there is a high likelihood it may not be visible on a dark or light theme, respectively. Similarly, do not set fonts verbatim, but use the
<code>var(--kbin-body-font-family)</code> for a set of fallback fonts.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_conventions">Conventions</h4>
<div class="ulist">
<ul>
<li>
<p>MUST: 4-space indentation on *.js files</p>
</li>
<li>
<p>MUST: 2-space indentation on *.json files</p>
</li>
<li>
<p>MUST: space before function paren</p>
</li>
<li>
<p>MUST: space before code blocks</p>
</li>
<li>
<p>MUST NOT: comma dangle</p>
</li>
<li>
<p>MUST NOT: spaces in curly objects</p>
</li>
<li>
<p>PREFER: 80 line width</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <code>.eslintrc.json</code> in the repository root for details.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PREFER: <a href="https://www.conventionalcommits.org/en/v1.0.0/">conventional commits</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>